<%= form_tag account_charges_path, id:'charge' do %>
  <% if flash[:error].present? %>
    <div id="error_explanation">
      <p><%= flash[:error] %></p>
    </div>
  <% end %>

  <%= hidden_field_tag :token_id %>

  <div class="row">
    <div class="col-sm-6 pr-sm-2">
      <select class="custom-select form-control" name="amount">
        <option value="100">$1.00 USD</option>
        <option value="500">$5.00 USD</option>
        <option value="1000">$10.00 USD</option>
        <option value="5000">$50.00 USD</option>
        <option value="10000">$100.00 USD</option>
      </select>
    </div>
    <div class="col-sm-6 pl-sm-2 mt-3 mt-sm-0">
      <button id="stripe-button" class="btn btn-primary form-control" role="button">Pay with card</button>
    </div>
  </div>

  <script src="https://checkout.stripe.com/checkout.js"></script>
  <script>
    const handler = StripeCheckout.configure({
      key:             "<%= Rails.configuration.stripe[:publishable_key] %>",
      name:            "Picture",
      description:     "data top up",
      allowRememberMe: "false",
      email:           "<%= current_user.email %>",
      locale:          "auto",
      token: function(token) {
        button.prop('disabled', true);
        $('input[name=token_id]').val(token.id);
        $('form#charge').submit();
      }
    });

    const button = $('#stripe-button');

    button.on('click', function(e) {
      //button.prop('disabled', true);
      handler.open({
        amount: $('select[name=amount]').val()
      })
      e.preventDefault();
    });

    $(window).on('popstate', function() {
      handler.close();
    });
  </script>
<% end %>
